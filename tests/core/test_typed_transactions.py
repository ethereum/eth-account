import pytest
from eth_account._utils.typed_transactions import (
    TypedTransaction,
)
from hexbytes import (
    HexBytes,
)

TEST_CASES = [
    {
        "expected_hash": '0x4f53cc08773081c51a1da2dc8df07b2e58cf8e359239efdb8dbf049be448974d',
        "expected_raw_transaction": "0x01f8ad82076c22843b9aca00830186a09409616c3d61b3331fc4109a9e41a8bdb7d9776609865af3107a400086616263646566f838f7940000000000000000000000000000000000000001e1a0010000000000000000000000000000000000000000000000000000000000000001a08289e85fa00f8f7f78a53cf147a87b2a7f0d27e64d7571f9d06a802e365c3430a017dc77eae36c88937db4a5179f57edc6119701652f3f1c6f194d1210d638a061",
        "transaction": {
            "gas":"0x186a0",
            "gasPrice":"0x3b9aca00",
            "data":"0x616263646566",
            "nonce":"0x22",
            "to":"0x09616C3d61b3331fc4109a9E41a8BDB7d9776609",
            "value":"0x5af3107a4000",
            "type":"0x1",
            "accessList":[
                [
                    "0x0000000000000000000000000000000000000001",
                    ["0x0100000000000000000000000000000000000000000000000000000000000000"],
                ],
            ],
            "chainId":"0x76c",
            "v":"0x1",
            "r":"0x8289e85fa00f8f7f78a53cf147a87b2a7f0d27e64d7571f9d06a802e365c3430",
            "s":"0x17dc77eae36c88937db4a5179f57edc6119701652f3f1c6f194d1210d638a061",
        }
    },
    {
        "expected_hash": "0x660fd2280b7ce4a6b625ccb2e1bb56fe3ede2ed91a7ff0b82a8d61e4709b82f6",
        "expected_raw_transaction": "0x01f87482076c27843b9aca00830186a09409616c3d61b3331fc4109a9e41a8bdb7d9776609865af3107a400086616263646566c080a0bad1a40fa2d90dc7539831bb82dfccf9b7094eab238d50c4369b805fb7241c58a046ab7eb7ff8cdfd203847b7e1b2f9e41208bba76a86ae3eeb97fe2727763aa12",
        "transaction": {
            "gas":"0x186a0",
            "gasPrice":"0x3b9aca00",
            "data":"0x616263646566",
            "nonce":"0x27",
            "to":"0x09616C3d61b3331fc4109a9E41a8BDB7d9776609",
            "value":"0x5af3107a4000",
            "type":"0x1",
            "accessList":[],
            "chainId":"0x76c",
            "v":"0x0",
            "r":"0xbad1a40fa2d90dc7539831bb82dfccf9b7094eab238d50c4369b805fb7241c58",
            "s":"0x46ab7eb7ff8cdfd203847b7e1b2f9e41208bba76a86ae3eeb97fe2727763aa12",
        },
    },
    {
        "expected_hash": "0x0bb62e4f43fb7616e8fcc02eb7b06d225842e3562923e57ef66faa723cf381df",
        "expected_raw_transaction": "0x01f903670182ad68852cfc7453e083074fa3944a137fd5e7a256ef08a7de531a17d0be0cc7b6b680b901a46dbf2fa0000000000000000000000000e592427a0aece92de3edee1f18e0157c05861564000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104414bf3890000000000000000000000007d1afa7b718fb893db30a3abc0cfc608aacfebb0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000bb80000000000000000000000004a137fd5e7a256ef08a7de531a17d0be0cc7b6b60000000000000000000000000000000000000000000000000000000060d1254a0000000000000000000000000000000000000000000005ad1a85034041c00000000000000000000000000000000000000000000000000000d855a5dec8706800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f90156f87d94290a6a7460b308ee3f19023d2d00de604bcf5b42f866800104a0b4c32d61ed12936769c68071a161309a6848a0d43ffce43d5f529f86b73529c3a0b4c32d61ed12936769c68071a161309a6848a0d43ffce43d5f529f86b73529c4a0b4c32d61ed12936769c68071a161309a6848a0d43ffce43d5f529f86b73529c5f87a947d1afa7b718fb893db30a3abc0cfc608aacfebb0f863a014d5312942240e565c56aec11806ce58e3c0e38c96269d759c5d35a2a2e4a449a037b0b82ee5d8a88672df3895a46af48bbcd30d6efcc908136e29456fa30604bba0bc3269c3ddeb063124d8c8f40c383f40b2d3212d819cd058041d83e583892d9af85994c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2f842a02c47f2c83db5d085fba21d1d91bba6245435c688f64423ba360424c27e4558f2a08275c17064fd92fe5b41f3fc855dd1c473a6b1800a19406cb089c51a5c17536180a0184ebebb6708b6574aab7020225feedad503b1aecb00dc92eb522f8fdd7897f9a042064fcf0ed57c864c99b3c36cf304dbbc2b85992cb7a4ae963fe965c24f5105",
        "transaction": {
            "gas":"0x74fa3",
            "gasPrice":"0x2cfc7453e0",
            "data":"0x6dbf2fa0000000000000000000000000e592427a0aece92de3edee1f18e0157c05861564000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104414bf3890000000000000000000000007d1afa7b718fb893db30a3abc0cfc608aacfebb0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000bb80000000000000000000000004a137fd5e7a256ef08a7de531a17d0be0cc7b6b60000000000000000000000000000000000000000000000000000000060d1254a0000000000000000000000000000000000000000000005ad1a85034041c00000000000000000000000000000000000000000000000000000d855a5dec8706800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "nonce":"0xad68",
            "to":"0x4A137FD5e7a256eF08A7De531A17D0BE0cc7B6b6",
            "value":"0x0",
            "type":"0x1",
            "accessList": [
                [
                    "0x290a6a7460b308ee3f19023d2d00de604bcf5b42",
                    [
                        "0x0000000000000000000000000000000000000000000000000000000000000000",
                        "0x0000000000000000000000000000000000000000000000000000000000000001",
                        "0x0000000000000000000000000000000000000000000000000000000000000004",
                        "0xb4c32d61ed12936769c68071a161309a6848a0d43ffce43d5f529f86b73529c3",
                        "0xb4c32d61ed12936769c68071a161309a6848a0d43ffce43d5f529f86b73529c4",
                        "0xb4c32d61ed12936769c68071a161309a6848a0d43ffce43d5f529f86b73529c5",
                    ],
                ],
                [
                    "0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0",
                    [
                        "0x14d5312942240e565c56aec11806ce58e3c0e38c96269d759c5d35a2a2e4a449",
                        "0x37b0b82ee5d8a88672df3895a46af48bbcd30d6efcc908136e29456fa30604bb",
                        "0xbc3269c3ddeb063124d8c8f40c383f40b2d3212d819cd058041d83e583892d9a",
                    ],
                ],
                [
                    "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
                    [
                        "0x2c47f2c83db5d085fba21d1d91bba6245435c688f64423ba360424c27e4558f2",
                        "0x8275c17064fd92fe5b41f3fc855dd1c473a6b1800a19406cb089c51a5c175361",
                    ],
                ],
            ],
            "chainId":"0x1",
            "v":"0x0",
            "r":"0x184ebebb6708b6574aab7020225feedad503b1aecb00dc92eb522f8fdd7897f9",
            "s":"0x42064fcf0ed57c864c99b3c36cf304dbbc2b85992cb7a4ae963fe965c24f5105",
        },
    },
]

@pytest.mark.parametrize(
    'test_case',
    TEST_CASES,
    ids=['non-empty-list', 'empty-list', 'many-acls'],
)
def test_hash(test_case):
    expected = test_case["expected_hash"]
    transaction = TypedTransaction.from_dict(test_case["transaction"])
    hash = transaction.hash()
    actual = HexBytes(hash).hex()
    assert actual == expected

@pytest.mark.parametrize(
    'test_case',
    TEST_CASES,
    ids=['non-empty-list', 'empty-list', 'many-acls'],
)
def test_encode(test_case):
    expected = test_case["expected_raw_transaction"]
    transaction = TypedTransaction.from_dict(test_case["transaction"])
    raw_transaction = transaction.encode()
    actual = HexBytes(raw_transaction).hex()
    assert actual == expected    
